<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Port Map</title>
<style>
  html, body, #stage, svg { touch-action: none; }
  html,body{margin:0;height:100%}
  #stage{position:relative;width:100vw;height:100svh;overflow:hidden;background:#49aeb6}
  svg{width:100%;height:100%;display:block;touch-action:none;user-select:none}

  .hud{position:absolute;z-index:30;left:12px;top:12px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:10px;background:#ffffffcc;border:1px solid #d0d0d0;font:600 13px/1 system-ui}
  .btn:active{transform:translateY(1px)}
  .warn{position:absolute;z-index:40;right:12px;top:12px;background:#fff3cd;border:1px solid #ffe69c;color:#7f5f00;padding:8px 10px;border-radius:10px;font:600 13px/1.2 system-ui}

@supports (-webkit-touch-callout: none){ #stage{ height:-webkit-fill-available; } }

  .jobs{position:absolute;z-index:35;left:50%;top:14px;transform:translateX(-50%);background:#ffffff;border:1px solid #e4e7eb;box-shadow:0 10px 30px #0003;border-radius:14px;width:min(1100px,94vw);overflow:hidden}
  .jobs-header{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border-bottom:1px solid #eef1f4}
  .jobs-title{font:700 15px/1.2 system-ui;color:#1b2734}
  .jobs-toggle{margin-left:auto;border:0;background:#edf2f7;border-radius:10px;padding:6px 10px;font:700 13px;cursor:pointer}
  .jobs-body{max-height:40vh;overflow:auto}
  table{width:100%;border-collapse:collapse;font:500 13px/1.45 system-ui}
  th,td{padding:8px 10px;border-bottom:1px solid #eef2f6;white-space:nowrap}
  th{position:sticky;top:0;background:#f8fafc;font-weight:700;color:#44566c;z-index:1}
  td.ship{font-weight:700;color:#163a6b}
  .bar{height:18px;background:#e9ecef;border-radius:5px;overflow:hidden;text-align:center}
  .bar>i{display:block;height:100%;background:#34c759}
  tr:hover{background:#f6fbff;cursor:pointer}
 
  .cards{display:none;padding:10px;gap:10px}
  .card{border:1px solid #eef1f4;border-radius:12px;padding:10px 12px;background:#fff}
  .card .hdr{font:700 14px/1.2 system-ui;color:#163a6b;margin-bottom:6px}
  .card .cols{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;font:500 13px/1.45 system-ui}
  .card .cols div:nth-child(odd){color:#607085}
  .card .cols div:nth-child(even){color:#1b2734}

  .chev{position:absolute;z-index:50;right:10px;top:10px;width:36px;height:36px;border-radius:10px;border:1px solid #e3e6ea;background:#fff;display:none;align-items:center;justify-content:center;font:900 16px/1 system-ui;box-shadow:0 6px 16px #0003;cursor:pointer}
  .chev.rotate{transform:rotate(180deg)}
  @media (max-width: 960px){
    .jobs{top:0; left:auto; right:0; transform:none;height:100%; width:min(96vw, 420px); max-width:96vw;border-radius:0; box-shadow:-10px 0 30px #0004; translate:100% 0; transition:translate .25s ease;}
    .jobs.open{ translate:0 0 }
    .jobs-body{max-height:calc(100% - 46px)}
    .chev{display:flex}
    #jobsTable{display:none}
    #jobsCards{display:grid}
    .jobs-toggle{display:none}
  }
  @media (max-width:640px){ .hide-sm{display:none} }
 .crane{
  padding: 10px;
  }
  .panel{position:absolute;z-index:40;left:50%;top:18px;transform:translateX(-50%);background:#fff;border:1px solid #e3e6ea;box-shadow:0 10px 30px #0002;border-radius:12px;min-width:320px;max-width:92vw;padding:14px 16px;display:none}
  .panel h3{margin:0 0 8px;font:700 18px/1.2 system-ui}
  .rows{display:grid;grid-template-columns:120px 1fr;gap:6px 12px;font:500 13px/1.5 system-ui}
  .rows div:nth-child(odd){color:#607085}
  .rows div:nth-child(even){color:#1b2734}
  .close{position:absolute;right:10px;top:10px;border:0;background:#f3f4f6;border-radius:8px;padding:6px 10px;cursor:pointer}
  
  #layer-ships{pointer-events:visiblePainted}
  .ship{pointer-events:visiblePainted}
  .ship image,.ship text{pointer-events:none}
  .ship .hit{pointer-events:all;cursor:pointer}

  .clouds{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden}
  .cloud{position:absolute;top:-20px;width:120px;opacity:0.8}
  .cloud1{animation:cloudX 60s linear infinite}
  .cloud2{animation:cloudX 90s linear infinite reverse;width:150px;top:-30px}
  .cloud3{animation:cloudX 75s linear infinite;width:100px;top:-15px}
  @keyframes cloudX { 0%{left:-200px} 100%{left:100vw} }
 
  .sec-body {
    max-width: 300px;
}
  .pop.narrow { min-width:auto; max-width:260px; }
  .pop{
    position:absolute; z-index:60;
    min-width:300px; max-width:min(92vw,460px);
    background:#fff; border-radius:12px;
    box-shadow:0 12px 36px #0003;
    overflow:visible; display:none; border-top:none;
  }
  .pop.show{display:block}
  .pop .hd{
    background:#0b66c3;color:#fff;font:800 14px/1.35 system-ui;
    padding:8px 10px;text-align:center;display:flex;align-items:center;justify-content:center;
    border-top-left-radius:12px;border-top-right-radius:12px;
  }
  .pop .bd{ padding:0; max-height:60vh; overflow-y:auto }
  .pop .sec{ border-top:1px solid #e6edf4 }
  .pop .sec:first-child{ border-top:0 }
  .pop .sec-hd{ font:800 12px/1.2 system-ui; letter-spacing:.2px; padding:8px 12px; border-bottom:1px solid #e6edf4; text-transform:uppercase }
  .pop .sec.table table{ width:100%; border-collapse:collapse; table-layout:fixed }
  .pop .sec.table td{ padding:8px 12px; border-bottom:0; vertical-align:top; font:600 13px/1.45 system-ui }
  .pop .sec.table td:first-child{ color:#5f7086; width:55% }
  .pop .sec.table td:last-child{ color:#0e2438; text-align:right; word-break:break-word }
  .pop .sec.blue  .sec-hd{ background:#eaf4ff; color:#0c4ea3 }
  .pop .sec.amber .sec-hd{ background:#fff6df; color:#7a5200 }
  .pop .sec.gray  .sec-hd{ background:#f4f6f8; color:#394a5b }
  .pop .pill{ display:inline-block; padding:2px 6px; border-radius:6px; font-weight:800; font-size:12px }
  .pop .pill.blue{ background:#eaf4ff; color:#0c4ea3 }
  .pop .pill.green{ background:#eafaf4; color:#116a52 }
  .pop .sum-row td{ font-weight:800 }

  .pop::before,.pop::after{
    content:""; position:absolute; width:0; height:0; pointer-events:none;
    left:var(--ax,50%); transform:translateX(-50%); border:12px solid transparent; display:none;
  }
  .pop.above::before{ display:block; bottom:-22px; border-top-color:#dfe5ec; z-index:59; }
  .pop.above::after{ display:block; bottom:-21px; border-top-color:#fff;   z-index:60; }
  .pop.below::before,.pop.below::after{ display:none !important; }
</style>
</head>
<body>
<div id="stage">
  <!-- Popover -->
  <div class="pop" id="pop" role="dialog" aria-modal="false">
    <div class="hd" id="popTitle">Tiêu đề</div>
    <div class="bd" id="popBody"></div>
  </div>

  <div class="hud">
    <button class="btn" id="zoomIn">＋</button>
    <button class="btn" id="zoomOut">－</button>
  </div>
  <button class="chev" id="toggleJobs" aria-label="Mở/đóng danh sách">❯</button>
  <div class="warn" id="warn" style="display:none">Chưa có dữ liệu. Hãy nhập ở “Data Entry”.</div>

  <!-- Jobs -->
  <div class="jobs" id="jobsCard">
    <div class="jobs-header">
      <div class="jobs-title">Tiến độ làm hàng (theo tàu)</div>
      <button class="jobs-toggle" id="jobsToggle">Ẩn ▲</button>
    </div>
    <div class="jobs-body" id="jobsBody">
      <table id="jobsTable">
        <thead><tr><th>Bến</th><th>Tàu</th><th class="hide-sm">ShipKey</th><th class="hide-sm">ETA → ETD</th><th>%</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="jobsCards" class="cards"></div>
    </div>
  </div>

  <!-- Panels -->
  <div class="panel" id="shipPanel">
    <button class="close" id="closePanel">✕</button>
    <h3 id="pName">Tên tàu</h3>
    <div class="rows">
      <div>Tàu:</div><div id="pShipName">—</div>
      <div>Mã chuyến:</div><div id="pShipKey">—</div>
      <div>Bến (theo dữ liệu):</div><div id="pBerth">—</div>
      <div>Vị trí (u→px):</div><div id="pSpan">—</div>
      <div>Kích thước (ước tính):</div><div id="pSize">—</div>
      <div>Tiến độ:</div><div id="pProg">—</div>
      <div>ETA → ETD:</div><div id="pEtaEtd">—</div>
    </div>
  </div>

  <div class="panel" id="berthPanel">
    <button class="close" id="closeBerth">✕</button>
    <h3 id="bTitle">Tên bến</h3>
    <div class="rows">
      <div>Mã bến:</div><div id="bNo">—</div>
      <div>Chiều dài (m):</div><div id="bLen">—</div>
      <div>Độ sâu TK (hải đồ):</div><div id="bDepth">—</div>
      <div>Tải trọng (tấn):</div><div id="bPayload">—</div>
      <div>Vị trí (u):</div><div id="bSpan">—</div>
    </div>
  </div>

  <!-- World -->
  <svg id="root" viewBox="0 0 3000 2000" preserveAspectRatio="xMidYMid meet">
    <defs>
      <clipPath id="seaClip" clipPathUnits="userSpaceOnUse">
        <rect id="seaClipRect" x="0" y="0" width="0" height="0"/>
      </clipPath>
    </defs>
    <g id="camera">
      <image id="basemap" href="assets/port-map.svg" x="0" y="0" width="3000" height="2000" />
       <g id="layer-cranes"></g>
      <g id="layer-berths"></g>
      <g id="layer-ships" style="clip-path:url(#seaClip)"></g>
    </g>
  </svg>

  <div class="clouds">
    <img src="assets/cloud.png" class="cloud cloud1" alt="">
    <img src="assets/cloud.png" class="cloud cloud2" alt="">
    <img src="assets/cloud.png" class="cloud cloud3" alt="">
  </div>
</div>

<script>
'use strict';

/* ===== GLOBALS ===== */
var MAP={W:3000,H:2000};
var SEA={x1:80,x2:2920,y:720,height:360};
var SEA_PAD=300,PAD_VIS=6,LANE_GAP_PX=10;
var BEAM_VISUAL_SCALE=1.6,MIN_SHIP_HEIGHT=14;
var SHIP_SPRITES=[{src:'assets/cargo-ship-2.png',w:419,h:94},{src:'assets/tau-tong-hop-1.png',w:419,h:94}];
var CAN_HOVER=window.matchMedia && matchMedia('(hover:hover)').matches;

var stage=document.getElementById('stage'),
    svg=document.getElementById('root'),
    camera=document.getElementById('camera');
var userInteracted=false;

/* ===== HELPERS ===== */
function $(id){ return document.getElementById(id); }
function svgEl(tag,attrs,text){
  var el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  if(attrs){ for(var k in attrs){ if(Object.prototype.hasOwnProperty.call(attrs,k)){ el.setAttribute(k, String(attrs[k])); } } }
  if(text!=null) el.textContent=String(text);
  return el;
}
function fmtDate(s){
  if(!s) return '—';
  var d=new Date(s); if(isNaN(d)) return s;
  function pad(n){ n=String(n); return n.length<2?('0'+n):n; }
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
}

 
var scale=1, tx=0, ty=0; var MIN=0.5, MAX=8;
function apply(){ camera.setAttribute('transform','translate('+tx+','+ty+') scale('+scale+')'); }
function fitHeight(){ var vw=stage.clientWidth, vh=stage.clientHeight; scale=vh/MAP.H; tx=(vw-MAP.W*scale)/2; ty=(vh-MAP.H*scale)/2; apply(); }
function clientToSvgPoint(x,y){ var p=svg.createSVGPoint(); p.x=x; p.y=y; return p.matrixTransform(svg.getScreenCTM().inverse()); }
function zoomAtClient(clientX, clientY, factor){
  var r = svg.getBoundingClientRect();
  var cxLocal = clientX - r.left;
  var cyLocal = clientY - r.top;

 
  var world = clientToSvgPoint(clientX, clientY);

 
  var ns = Math.max(MIN, Math.min(MAX, scale * factor));
 
  tx = cxLocal - world.x * ns;
  ty = cyLocal - world.y * ns;
  scale = ns;
  apply();
}

function zoomBy2(f){
  var r=svg.getBoundingClientRect(), cx=r.width/2, cy=r.height/2;
  var p=clientToSvgPoint(r.left+cx,r.top+cy);
  var ns=Math.max(MIN,Math.min(MAX,scale*f));
  tx=p.x-(p.x-tx)*(ns/scale); ty=p.y-(p.y-ty)*(ns/scale); scale=ns; apply();
}
var lastMouse = {x: null, y: null};
function zoomBy(f){
  var r = svg.getBoundingClientRect();
  var cx = (lastMouse.x != null) ? lastMouse.x : (r.left + r.width/2);
  var cy = (lastMouse.y != null) ? lastMouse.y : (r.top  + r.height/2);
  zoomAtClient(cx, cy, f);
}
$('zoomIn').onclick=function(){ userInteracted=true; zoomBy2(1.15); };
$('zoomOut').onclick=function(){ userInteracted=true; zoomBy2(0.87); };

 
function zoomHeightNow(mult, center){
  if(mult==null) mult=1.0; if(!center) center='map';
  var vw=stage.clientWidth, vh=stage.clientHeight*2;
  var base = vh / MAP.H;
  var ns = Math.max(MIN, Math.min(MAX, base * mult));
  if(vw<1000)       scale = ns+1.33;
  else if(vw>1700)  scale = ns-0.13;
  else              scale = ns+0.96;

  if(center==='sea'){
    var cx=(SEA.x1+SEA.x2)/2, cy=SEA.y-SEA.height/2;
    tx=(vw/2) - cx*scale;
    ty=(vh/2) - cy*scale;
  }else{
    tx=(vw - MAP.W*scale)/2;
    ty=(vh - MAP.H*scale)/2;
  }

  var currentWidth  = MAP.W*scale;
  var currentHeight = MAP.H*scale;
  if(vw>=1000 && vw<=1700){ tx=(vw-currentWidth)/3.2;  ty=(vh-currentHeight)/10; }
  else if(vw>1700){         tx=(vw-currentWidth)/5;  ty=(vh-currentHeight)-190; }
  else{                     tx=(vw-currentWidth)/3.55;  ty=(vh-currentHeight)/3;   }

  apply(); userInteracted=true;
}

var FRAME_MAX=24, PAN_DAMPING=0.00085, PAN_MIN_SPEED=0.005;
var BOOST_TOUCH_DRAG=1.25, BOOST_TOUCH_RELEASE=1.80, BOOST_MOUSE_DRAG=1.00, BOOST_MOUSE_RELEASE=0.00;
var VEL_WINDOW_MS=120;
var dragging=false, lockDrag=false, lastX=0,lastY=0,lastT=0, vx=0,vy=0, flingId=null;
var velHist=[];
function stopFling(){ if(flingId){ cancelAnimationFrame(flingId); flingId=null; } }
function startFling(){ stopFling(); var prev=performance.now(); function step(now){
  var dt=Math.min(FRAME_MAX, now-prev); prev=now;
  var k=Math.exp(-PAN_DAMPING*dt); vx*=k; vy*=k; tx+=vx*dt; ty+=vy*dt; apply();
  if(Math.sqrt(vx*vx+vy*vy)>PAN_MIN_SPEED) flingId=requestAnimationFrame(step); else flingId=null;
} flingId=requestAnimationFrame(step); }
function pushVelocity(instVx,instVy,dt,t){
  velHist.push({vx:instVx,vy:instVy,dt:dt,t:t});
  var cutoff=t-VEL_WINDOW_MS;
  while(velHist.length && velHist[0].t<cutoff) velHist.shift();
}
function weightedVelocity(){
  if(!velHist.length) return {vx:0,vy:0};
  var tMax=velHist[velHist.length-1].t, sx=0,sy=0,sw=0, i;
  for(i=0;i<velHist.length;i++){
    var s=velHist[i], age=tMax-s.t, w=1-(age/VEL_WINDOW_MS);
    sx+=s.vx*w; sy+=s.vy*w; sw+=w;
  }
  return sw?{vx:sx/sw,vy:sy/sw}:{vx:0,vy:0};
}
var panQueued=false, panDX=0, panDY=0;
function queuePan(dx,dy){
  panDX+=dx; panDY+=dy;
  if(panQueued) return;
  panQueued=true;
  requestAnimationFrame(function(){ tx+=panDX; ty+=panDY; apply(); panDX=0; panDY=0; panQueued=false; });
}
var pts={}, pinching=false, pinchPrevDist=0, pinchQueued=false;
function dist(a,b){ var dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.sqrt(dx*dx+dy*dy); }
svg.addEventListener('pointerdown', function(e){
  e.preventDefault();
  pts[e.pointerId]={pointerId:e.pointerId, clientX:e.clientX, clientY:e.clientY};
  var ids=Object.keys(pts);
  if(ids.length===2){ var a=pts[ids[0]], b=pts[ids[1]]; pinching=true; dragging=false; pinchPrevDist=dist(a,b); return; }
  lockDrag=!!e.target.closest && !!e.target.closest('.ship, .berth, .crane, .hit');
  if(lockDrag) return;
  if(e.pointerType!=='touch') stopFling();
  dragging=true; lastX=e.clientX; lastY=e.clientY; lastT=e.timeStamp||performance.now(); velHist.length=0;
},{passive:false});
svg.addEventListener('pointermove', function(e){
  if(pts[e.pointerId]){ pts[e.pointerId]={pointerId:e.pointerId, clientX:e.clientX, clientY:e.clientY}; }
  var ids=Object.keys(pts);
  lastMouse.x=e.clientX;
  lastMouse.y=e.clientY;
    if(pinching && ids.length===2){
    if(pinchQueued) return;
    pinchQueued=true;
    requestAnimationFrame(function(){
      pinchQueued=false;
      var a=pts[ids[0]], b=pts[ids[1]];
      var d=dist(a,b); if(d<=0) return;
      var r=svg.getBoundingClientRect();
      var mx=(a.clientX+b.clientX)/2 - r.left, my=(a.clientY+b.clientY)/2 - r.top;
      var raw=scale*(d/pinchPrevDist);
      var maxStep=1.06, minStep=1/maxStep;
      var limited=Math.max(minStep, Math.min(maxStep, raw/scale));
      var ns=Math.max(MIN, Math.min(MAX, scale*limited));
      var world=clientToSvgPoint(mx+r.left, my+r.top);
      scale=ns; tx=mx - world.x*scale; ty=my - world.y*scale; apply();
      pinchPrevDist=d;
    });
    return;
  }
  if(!dragging||lockDrag) return;
  e.preventDefault();
  var now=e.timeStamp||performance.now(), dt=now-lastT; if(dt<1) dt=1; if(dt>FRAME_MAX) dt=FRAME_MAX;
  var dx=e.clientX-lastX, dy=e.clientY-lastY;
  var boost=(e.pointerType==='touch')?BOOST_TOUCH_DRAG:BOOST_MOUSE_DRAG;
  queuePan(dx*boost, dy*boost);
  pushVelocity((dx*boost)/dt, (dy*boost)/dt, dt, now);
  lastX=e.clientX; lastY=e.clientY; lastT=now;
},{passive:false});
function endPtr(e){
  delete pts[e.pointerId];
  if(pinching && Object.keys(pts).length<2) pinching=false;
  if(dragging){
    dragging=false;
    var avg=weightedVelocity();
    if(e.pointerType==='touch'){
      vx=avg.vx*BOOST_TOUCH_RELEASE; vy=avg.vy*BOOST_TOUCH_RELEASE;
      if(Math.sqrt(vx*vx+vy*vy)>PAN_MIN_SPEED) startFling();
    }else{ vx=0; vy=0; stopFling(); }
  }
  lockDrag=false;
}
svg.addEventListener('pointerup', endPtr, {passive:true});
svg.addEventListener('pointercancel', endPtr, {passive:true});
svg.addEventListener('pointerleave', endPtr, {passive:true});
svg.addEventListener('pointerout', endPtr, {passive:true});
// svg.addEventListener('wheel', function(e){
//   e.preventDefault(); stopFling();
//   var r=svg.getBoundingClientRect();
//   var cx=r.left+r.width/2, cy=r.top+r.height/2;
//   var world=clientToSvgPoint(cx,cy);
//   var f=(e.deltaY>0)?0.9:1.1;
//   var ns=Math.max(MIN,Math.min(MAX,scale*f));
//   tx=(cx-r.left)-world.x*ns; ty=(cy-r.top)-world.y*ns; scale=ns; apply();
// },{passive:false});
svg.addEventListener('wheel', function(e){
  e.preventDefault();
  stopFling(); // khi zoom thì dừng quán tính

  var factor = (e.deltaY > 0) ? 0.9 : 1.1;
  zoomAtClient(e.clientX, e.clientY, factor);
}, {passive:false});
 
new ResizeObserver(function(){
  if (!userInteracted) zoomHeightNow(1.2,'map');
  else apply();
}).observe(stage);

/* ===== CLIP SEA ===== */
(function(){
  var left=SEA.x1+SEA_PAD, right=SEA.x2-SEA_PAD;
  var seaClipRect=document.getElementById('seaClipRect');
  seaClipRect.setAttribute('x',left);
  seaClipRect.setAttribute('y',SEA.y-SEA.height);
  seaClipRect.setAttribute('width',right-left);
  seaClipRect.setAttribute('height',SEA.height);
})();

/* ===== DATA LOAD ===== */
async function loadData(){
  var warn=$('warn');
  var raw=localStorage.getItem('portMapData');
 
  if(raw){
    try{ return JSON.parse(raw); }
    catch(e){ console.error('JSON lỗi localStorage:',e); warn.style.display='block'; warn.textContent='JSON lỗi trong localStorage. Sẽ thử file dữ liệu mặc định...'; }
  }
  try{
    var res=await fetch('port-map.data.json',{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    var obj=await res.json();
    if(obj && typeof obj.data==='string') return JSON.parse(obj.data);
    if(obj && (obj.BerthData||obj.ShipData||obj.JobData)) return obj;
    throw new Error('File port-map.data.json không đúng cấu trúc.');
  }catch(e){
    console.error('Không load được file fallback:',e);
    warn.style.display='block';
    warn.textContent='Không có dữ liệu (localStorage và file JSON đều lỗi).';
    throw e;
  }
}

/* ===== UNITS → PIXELS (0 ở PHẢI) ===== */
function normalizeUnits(berths){
  var maxU=0; if(!berths) return maxU;
  for(var i=0;i<berths.length;i++){ var v=+berths[i].PosTo||0; if(v>maxU) maxU=v; }
  return maxU;
}
function buildUnitToPx(totalUnits){
  var left  = SEA.x1 + SEA_PAD;
  var right = SEA.x2 - SEA_PAD;
  var usableW   = right - left;
  var pxPerUnit = usableW / Math.max(1, totalUnits);
  return {
    origin:left, rightBound:right, usableW:usableW, pxPerUnit:pxPerUnit,
    uToPx:function(u){ return right - u * pxPerUnit; } // PHẢI → TRÁI
  };
}

/* ===== COMMON ===== */
function getShipSpanUAbsolute(ship,totalUnits){
  var u1=+ship.FROM_POS||0, u2=+ship.TO_POS||0;
  if(!(u1>0&&u2>0)){
    var f=+ship.FROM_POS||0, t=+ship.TO_POS||0;
    if(f>0&&t>0){
      var k=1, mx=Math.max(f,t);
      if(mx>totalUnits*8 && mx<totalUnits*200) k=10;
      if(mx>=totalUnits*200) k=100;
      u1=f/k; u2=t/k;
    }
  }
  if(u2<u1){ var tmp=u1; u1=u2; u2=tmp; }
  u1=Math.max(0,Math.min(u1,totalUnits));
  u2=Math.max(0,Math.min(u2,totalUnits));
  return (u2-u1>1)?{u1:u1,u2:u2}:null;
}
function progressFromJobs(jobData,shipKey){
  var total=0, done=0, i;
  if(jobData){
    for(i=0;i<jobData.length;i++){
      var j=jobData[i]; if(j.ShipKey!==shipKey) continue;
      total+= (+j.JobCount||0);
      if(j.Status==='F' || j.Status==='R') done+= (+j.JobCount||0);
    }
  }
  return total?Math.round(100*done/total):0;
}
function berthNoToName(berths, berthNo){
  if(!berthNo) return '—';
  if(!berths) return berthNo;
  for(var i=0;i<berths.length;i++){ if(berths[i].BerthNo===berthNo) return berths[i].BerthName||berthNo; }
  return berthNo;
}
 
function assignLanesNoOverlap(items, minGapPx) {
  if (minGapPx == null) minGapPx = 8;

  items.sort(function(a, b){
    function t(s1,s2,s3){
      var d=null;
      if(s1){ d=new Date(s1); if(!isNaN(d)) return +d; }
      if(s2){ d=new Date(s2); if(!isNaN(d)) return +d; }
      if(s3){ d=new Date(s3); if(!isNaN(d)) return +d; }
      return 0;
    }
    var ta=t(a.ship.BerthDate, a.ship.ETA, a.ship.ETB);
    var tb=t(b.ship.BerthDate, b.ship.ETA, b.ship.ETB);
    if (ta !== tb) return ta - tb;
    if (a.px.x1 !== b.px.x1) return a.px.x1 - b.px.x1;
    var ka=a.ship.ShipKey||'', kb=b.ship.ShipKey||'';
    return ka<kb ? -1 : (ka>kb ? 1 : 0);
  });

  var lanes = [];        
  var laneHeights = [];  

  function overlaps(a1,a2,b1,b2,gap){
    return !( (a2 <= b1 - gap) || (a1 >= b2 + gap) );
  }

  for (var i=0;i<items.length;i++){
    var it = items[i], placed=false;
    for (var l=0;l<lanes.length;l++){
      var segs=lanes[l], ok=true;
      for (var k=0;k<segs.length;k++){
        var s=segs[k];
        if (overlaps(it.px.x1,it.px.x2,s.x1,s.x2,minGapPx)){ ok=false; break; }
      }
      if(ok){
        it.lane=l;
        segs.push({x1:it.px.x1,x2:it.px.x2});
        laneHeights[l]=Math.max(laneHeights[l]||0, it.h);
        placed=true; break;
      }
    }
    if(!placed){
      it.lane=lanes.length;
      lanes.push([{x1:it.px.x1,x2:it.px.x2}]);
      laneHeights.push(it.h);
    }
  }

  var laneOffsets=[], j;
  for(j=0;j<laneHeights.length;j++){
    if(j===0) laneOffsets[j]=0;
    else laneOffsets[j]=laneOffsets[j-1] + (laneHeights[j-1]||0) + LANE_GAP_PX;
  }
  return { laneCount: lanes.length, laneHeights: laneHeights, laneOffsets: laneOffsets };
}

 
var pop=document.getElementById('pop'), popTitle=document.getElementById('popTitle'), popBody=document.getElementById('popBody');
function hidePopover(){ pop.classList.remove('show','above','below'); }
document.addEventListener('pointerdown', function(e){ if(!pop.contains(e.target)) hidePopover(); });
document.addEventListener('keydown', function(e){ if(e.key==='Escape') hidePopover(); });
function showPopoverAtClient(cx, cy, prefer){
  if(!prefer) prefer='above';
  pop.style.left='0px'; pop.style.top='0px';
  pop.classList.add('show');
  var r0=pop.getBoundingClientRect();
  var flip=(prefer==='above' && (cy - r0.height - 16 < 8));
  var mode= flip ? 'below' : 'above';
  pop.classList.remove('above','below'); pop.classList.add(mode);

  var r=pop.getBoundingClientRect(), vw=window.innerWidth, vh=window.innerHeight;
  var left=Math.round(cx - r.width/2);
  var top =Math.round(mode==='above' ? (cy - r.height - 14) : (cy + 14));
  if(left<8) left=8; if(left>vw - r.width - 8) left=vw - r.width - 8;
  if(top<8) top=8; if(top>vh - r.height - 8) top=vh - r.height - 8;
  pop.style.left=left+'px'; pop.style.top=top+'px';
  var ax=cx-left; if(ax<16) ax=16; if(ax>r.width-16) ax=r.width-16;
  pop.style.setProperty('--ax', ax+'px');
}
function showPopoverForSvgAnchor(svgNode, prefer){
  var rect=svgNode.getBoundingClientRect();
  var cx=rect.left + rect.width/2;
  var cy=(prefer==='above')?rect.top:rect.bottom;
  showPopoverAtClient(cx,cy,prefer||'above');
}

 
var berthsLayer=document.getElementById('layer-berths');
function drawBerths(berths,uMap){
  berthsLayer.innerHTML='';
  var seaBottomY=SEA.y;
  var lineTop=seaBottomY+10, lineBottom=lineTop+20;


  (function(){
    var x0=uMap.uToPx(0);
    berthsLayer.appendChild(svgEl('line',{x1:x0,y1:lineTop,x2:x0,y2:lineBottom,stroke:'#ff8a00','stroke-width':'2','pointer-events':'none'}));
    berthsLayer.appendChild(svgEl('line',{x1:x0,y1:lineBottom,x2:x0-35,y2:lineBottom,stroke:'#ff8a00','stroke-width':'2','pointer-events':'none'}));
    var g0=svgEl('g',{transform:'translate('+x0+','+(lineTop-10)+')','pointer-events':'none'});
    berthsLayer.appendChild(g0);
    var t0=svgEl('text',{x:'0',y:'4','text-anchor':'middle','font-size':'11','font-weight':'700',fill:'#fff'},'0.0m');
    g0.appendChild(t0);
    requestAnimationFrame(function(){
      var bb=t0.getBBox(), padX=6, padY=3;
      var r=svgEl('rect',{x:bb.x-padX,y:bb.y-padY,width:bb.width+padX*2,height:bb.height+padY*2,rx:'4',ry:'4',fill:'#ff8a00',stroke:'#fff','stroke-width':'1'});
      g0.insertBefore(r,t0);
    });
  })();

  // ticks PosTo + label
  for(var i=0;i<(berths||[]).length;i++){
    var b=berths[i], u1=+b.PosFrom||0, u2=+b.PosTo||0; if(u2<=u1) continue;

    var tickX=uMap.uToPx(u2);
    berthsLayer.appendChild(svgEl('line',{x1:tickX,y1:lineTop,x2:tickX,y2:lineBottom,stroke:'#ff8a00','stroke-width':'2','pointer-events':'none'}));

    var gLabel=svgEl('g',{transform:'translate('+tickX+','+(lineTop-10)+')','pointer-events':'none'});
    berthsLayer.appendChild(gLabel);
    var textEl=svgEl('text',{x:'0',y:'4','text-anchor':'middle','font-size':'11','font-weight':'700',fill:'#fff'},(u2.toFixed(1)+'m'));
    gLabel.appendChild(textEl);
    (function(textEl,gLabel){
      requestAnimationFrame(function(){
        var bb=textEl.getBBox(), padX=6, padY=3;
        var rect=svgEl('rect',{x:bb.x-padX,y:bb.y-padY,width:bb.width+padX*2,height:bb.height+padY*2,rx:'4',ry:'4',fill:'#ff8a00',stroke:'#fff','stroke-width':'1'});
        gLabel.insertBefore(rect,textEl);
      });
    })(textEl,gLabel);

    var px1=uMap.uToPx(u1), px2=uMap.uToPx(u2);
    var xMid=(px1+px2)/2;
    var spanPx=Math.max(24, Math.abs(px2-px1));
    var tabW=Math.max(56,Math.min(180,spanPx*0.45))/2, tabH=18;

    var g=svgEl('g',{class:'berth',transform:'translate('+xMid+','+(seaBottomY+2)+')',style:'cursor:pointer'});
    berthsLayer.appendChild(g);
    g.appendChild(svgEl('rect',{x:-tabW/2,y:-tabH+16,width:tabW,height:tabH,rx:'6',fill:'#ff8a00'}));
    g.appendChild(svgEl('text',{x:'0',y:'12','font-size':'12','font-weight':'700',fill:'#fff','text-anchor':'middle'}, (b.BerthName||b.BerthNo||'Bến')));
    var hit=svgEl('rect',{x:-tabW/2-12,y:-tabH-12,width:tabW+24,height:tabH+26,fill:'#000','fill-opacity':'0.001'});
    g.appendChild(hit);

    (function(b,u1,u2,g){
      function showPopoverBerth(){
        var len=(b.BerthLength!=null?b.BerthLength:(u2-u1));
        popTitle.textContent=b.BerthName||b.BerthNo||'Bến';
        popBody.innerHTML=
          '<div class="sec table blue">'+
            '<div class="sec-hd">Thông tin bến</div>'+
            '<div class="sec-body"><table>'+
              '<tr><td>Mã bến</td><td>'+(b.BerthNo||'—')+'</td></tr>'+
              '<tr><td>Tên bến</td><td>'+(b.BerthName||'—')+'</td></tr>'+
              '<tr><td>Chiều dài (m)</td><td>'+len+'</td></tr>'+
              '<tr><td>Độ sâu TK</td><td>'+((b.BerthDepth!=null)?b.BerthDepth:'—')+'</td></tr>'+
              '<tr><td>Tải trọng (tấn)</td><td>'+((b.Payload!=null)?b.Payload:'—')+'</td></tr>'+
              '<tr><td>Vị trí (u)</td><td>'+u1+' → '+u2+'</td></tr>'+
            '</table></div>'+
          '</div>';
        showPopoverForSvgAnchor(g,'above');
      }
      g.addEventListener('click',function(){ showPopoverBerth(); });
      if(CAN_HOVER){
        var hideT=null;
        g.addEventListener('mouseenter',function(){ if(hideT) clearTimeout(hideT); showPopoverBerth(); });
        g.addEventListener('mouseleave',function(){ hideT=setTimeout(hidePopover,160); });
        pop.addEventListener('mouseenter',function(){ if(hideT) clearTimeout(hideT); });
        pop.addEventListener('mouseleave',function(){ hideT=setTimeout(hidePopover,160); });
      }
    })(b,u1,u2,g);
  }

  // ===== L ở điểm CUỐI (max PosTo), gạch dọc + gạch ngang sang PHẢI =====
  var maxU = normalizeUnits(berths);
  var xEnd = uMap.uToPx(maxU);
  berthsLayer.appendChild(svgEl('line',{x1:xEnd,y1:lineTop,x2:xEnd,y2:lineBottom,stroke:'#ff8a00','stroke-width':'2','pointer-events':'none'}));
  berthsLayer.appendChild(svgEl('line',{x1:xEnd,y1:lineBottom,x2:xEnd+35,y2:lineBottom,stroke:'#ff8a00','stroke-width':'2','pointer-events':'none'}));
}
var CRANE_SPRITE = { src:'assets/crane.png', w:55, h:55 };
var CRANE_MAX = 3;

// khoảng lùi vào đất liền tính từ mép mặt biển (đỉnh vùng SEA)
var DOCK_INSET_PX   = 14;   // bạn chỉnh 10–18 tuỳ ảnh map
var CRANE_FOOT_ROOM = 2;    // nhấc icon lên một chút để “đứng” gọn

var cranesLayer = document.getElementById('layer-cranes');

 function countQC(equipment){
  if(!equipment) return 0;
 
  var toks = equipment.split(';').map(function(s){return s.trim();}).filter(Boolean);
  var n = 0;
  for(var i=0;i<toks.length;i++){
    var t = toks[i].toUpperCase();
     n++;
  }
  return n;
}
function shoreY(){
  var shoreline = SEA.y - SEA.height;      
  var y = shoreline - DOCK_INSET_PX;       
  // giữ an toàn trong khung map
  if (y < 0) y = 0 + CRANE_FOOT_ROOM;
  return y;
}
function drawCranesForShip(item){
 
  var eqStr  = item.ship.Equipment || '';
  var eqList = eqStr.split(/[;,]+/).map(s => s.trim()).filter(Boolean);
  if (!eqList.length) return;
console.log(item.ship.BerthNo);
console.log(item.ship.Equipment);

  var n = Math.min(CRANE_MAX, countQC(item.ship.Equipment||''));
  if (n <= 0) { return;}

  var seaBottomY = SEA.y;
  var CRANE_Y_OFFSET = 100; 
  var y = seaBottomY + CRANE_Y_OFFSET - CRANE_SPRITE.h;


  var EDGE_PAD = 20;
  var left  = item.px.x1 + EDGE_PAD;
  var right = item.px.x2 - EDGE_PAD;
  if (right <= left) { right = item.px.x2; left = item.px.x1; }

  var usable = right - left;


  var MIN_GAP = Math.max(18, Math.floor(CRANE_SPRITE.w * 0.8));
  if (n > 1){
    var maxN = Math.floor(usable / MIN_GAP) + 1;
    n = Math.max(1, Math.min(n, maxN));
  }

  // var positions = [];
  // if (n === 1){
  //   positions.push((left + right) / 2);
  // } else {
  //   var step = usable / (n - 1);
  //   for (var k = 0; k < n; k++) positions.push(left + k * step);
  // }

    var seaBottomY = SEA.y;
  var y = seaBottomY + 100 - CRANE_SPRITE.h;  

  var left  = item.px.x1 + 20;
  var right = item.px.x2 - 20;
  var step = (right - left) / (n + 1);
    var halfW = CRANE_SPRITE.w / 2;

   if (!window.__CRANE_USED__) window.__CRANE_USED__ = [];
  for (var i = 0; i <n; i++){

 
    var cx = left + step * i;
    if (window.__CRANE_USED__.length === 0) {
 
  window.__CRANE_USED__.push(cx);
} 
else {
    var changed = true;
    while (changed){
      changed = false;
      for (var j=0;j<window.__CRANE_USED__.length;j++){
        var old = window.__CRANE_USED__[j];
        if (Math.abs(cx - old) < CRANE_SPRITE.w){
          cx = old + CRANE_SPRITE.w;           
          changed = true;
        }
      }
    }

 
    if (cx < left  + halfW) cx = left  + halfW;
    if (cx > right - halfW) cx = right - halfW+15;

    
    window.__CRANE_USED__.push(cx);
 }
  var g = svgEl('g',{class:'crane', transform:'translate('+(cx-CRANE_SPRITE.w/2)+','+y+')'});
  g.appendChild(svgEl('image',{
    href: CRANE_SPRITE.src,
    width: CRANE_SPRITE.w, height: CRANE_SPRITE.h,
    preserveAspectRatio:'xMidYMid meet'
  }));
  cranesLayer.appendChild(g);
    var deviceName = eqList[i] || 'Thiết bị?';
    g.setAttribute('title', deviceName);  

   
    (function(deviceName, g){
      function showPopoverCrane(){
        popTitle.textContent = deviceName;
        popBody.innerHTML =
          '<div class="sec table blue">'+
           
            '<div class="sec-body"><table>'+
            
              '<tr><td>Tàu đang sử dụng</td><td>'+(item.ship.ShipName||'—')+'</td></tr>'+
              '<tr><td>Bến đang làm việc</td><td>'+(item.ship.BerthNo||'—')+'</td></tr>'+
            '</table></div>'+
          '</div>';
        showPopoverForSvgAnchor(g,'above');
      }
      g.addEventListener('click', function(e){ e.stopPropagation(); showPopoverCrane(); });
      if (CAN_HOVER){
        var hideT=null;
        g.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); showPopoverCrane(); });
        g.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
        pop.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); });
        pop.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
      }
    })(deviceName, g);

    cranesLayer.appendChild(g);
  }
}
 

//  function drawCranesForShip(item){
 
//   var n = Math.min(CRANE_MAX, countQC(item.ship.Equipment||''));
//   if (n <= 0) { return;}
//   var eqList = item.ship.Equipment.split(/[;,]+/).map(s=>s.trim()).filter(Boolean);
//   if (!eqList.length) return;
 
//   var seaBottomY = SEA.y;
//   var y = seaBottomY + 100 - CRANE_SPRITE.h;  

//   var left  = item.px.x1 + 20;
//   var right = item.px.x2 - 20;
//   var step = (right - left) / (n + 1);

//   for (var i=1;i<=n;i++){
//     var cx = left + step * i;
//     var g = svgEl('g',{class:'crane', transform:'translate('+(cx-CRANE_SPRITE.w/2)+','+y+')'});
//     g.appendChild(svgEl('image',{
//       href:CRANE_SPRITE.src,
//       width:CRANE_SPRITE.w, height:CRANE_SPRITE.h
//     }));
//     cranesLayer.appendChild(g);
//   }
// }


/* ===== SHIPS ===== */
var shipsLayer=document.getElementById('layer-ships');
 function drawShips(ships, berths, uMap, jobData){
  shipsLayer.innerHTML = '';
  cranesLayer.innerHTML = ''; 
  var seaBottomY = SEA.y;
  var SEA_BOTTOM_CLEAR = 8  ;  
  var SHIFT_X = -28;         

   window.__CRANE_USED__ = [];

  var BMIN = Math.min(uMap.origin, uMap.rightBound);
  var BMAX = Math.max(uMap.origin, uMap.rightBound);
  var EDGE_PAD = 0;

 
  var seen = {}, uniq = [];
  for (var i=0;i<(ships||[]).length;i++){
    var s = ships[i];
    if (seen[s.ShipKey]) continue;
    seen[s.ShipKey] = 1;
    uniq.push(s);
  }

  // build items từ span tuyệt đối (KHÔNG cắt PAD_VIS)
  var totalU = uMap.usableW / uMap.pxPerUnit;
  var items = [];
  for (var k=0;k<uniq.length;k++){
    var ship = uniq[k];
    var spanAbs = getShipSpanUAbsolute(ship, totalU);
    if (!spanAbs) continue;

    // u -> px (0 ở bên PHẢI)
    var p1 = uMap.uToPx(spanAbs.u1);
    var p2 = uMap.uToPx(spanAbs.u2);
    var x1 = Math.min(p1, p2);
    var x2 = Math.max(p1, p2);

    // Clamp theo biên bản đồ
    var vx1 = Math.max(BMIN + EDGE_PAD, x1);
    var vx2 = Math.min(BMAX - EDGE_PAD, x2);
    if (vx2 <= vx1) vx2 = vx1 + 2;  
    var w = vx2 - vx1;             
    var ppm = uMap.pxPerUnit;

    var loaM = w / ppm;
    var estBeamM = (ship.BeamM && +ship.BeamM>0) ? (+ship.BeamM) : (loaM * 0.12);
    var h = Math.max(MIN_SHIP_HEIGHT, estBeamM * ppm * BEAM_VISUAL_SCALE);

    items.push({ ship: ship, abs: spanAbs, px:{x1:vx1,x2:vx2}, w:w, h:h, lane:0 });
  }
  if (!items.length) return;


  var lanes = assignLanesNoOverlap(items, 8);

 
  for (var i=0;i<items.length;i++){
    var it = items[i], w = it.w, h = it.h;

    
    
    drawCranesForShip(it);  
    var cx = (it.px.x1 + it.px.x2) / 2;
    var baseY = seaBottomY - SEA_BOTTOM_CLEAR - (lanes.laneOffsets[it.lane] || 0);

    var g = svgEl('g', {
      'class':'ship',
      transform: 'translate(' + cx + ',' + baseY + ')',
      'data-shipkey': it.ship.ShipKey
    });
    shipsLayer.appendChild(g);

 
    var visLeft  = -w/2 + SHIFT_X;
    var visRight =  w/2 + SHIFT_X;

   
    var spr = (it.ship.IsROROVessel) ? SHIP_SPRITES[1] : SHIP_SPRITES[0];
    g.appendChild(svgEl('image', {
      href: spr.src,
      x: visLeft, y: -h,
      width: w, height: h,
      preserveAspectRatio: 'none'    
    }));

    
    var prog = progressFromJobs(jobData, it.ship.ShipKey);

    var trackW = Math.max(8, Math.min(14, Math.floor(h * 0.22)));
    var trackH = Math.max(14, Math.min(Math.floor(h - 4), Math.floor(h * 0.96)));
    var trackY = -h + 2;
 
    var INSET_RIGHT = Math.max(6, Math.min(24, Math.floor(Math.min(h, w) * 0.20)));
    var EXTRA_STERN_SHIFT = (w >= 220 ? 10 : 0);
    var MARGIN_RIGHT = -10;

    var maxRightInside = visRight - MARGIN_RIGHT;         
    var trackX = maxRightInside - INSET_RIGHT - trackW - EXTRA_STERN_SHIFT;

 
    var minLeftInside = visLeft + 2;
    if (trackX < minLeftInside) trackX = minLeftInside;

    var fillH = Math.round(trackH * (prog / 100));
    var fillY = trackY + (trackH - fillH);

    g.appendChild(svgEl('rect', { x:trackX, y:trackY, width:trackW, height:trackH, rx:trackW/2, fill:'#e9ecef' }));
    g.appendChild(svgEl('rect', { x:trackX, y:fillY, width:trackW, height:fillH, rx:trackW/2, fill:'#34c759' }));

 
    var fontSize = Math.max(10, Math.min(16, Math.floor(h * 0.34)));
    var tyMid = trackY + trackH/2 + Math.floor(fontSize/3);
    var GAP_TX = Math.max(4, Math.min(10, Math.floor(h * 0.12)));
    var txRight = trackX + trackW + GAP_TX+10;
    var maxInside = visRight - 2;
    if (txRight > maxInside) txRight = maxInside;

    g.appendChild(svgEl('text', {
      x: trackX-5, y: trackY-5, 'font-size': fontSize, 'font-weight': '700',
      fill:'#1d3f77', 'text-anchor':'start'
    }, String(prog) + '%'));

    // Hitbox (trùm đúng ảnh đã dời)
    var hitPad = 8;
    var hit = svgEl('rect', {
      'class':'hit',
      x: visLeft - hitPad,
      y: -h - hitPad,
      width: (visRight - visLeft) + hitPad*2,
      height: h + hitPad*2,
      fill:'#000', 'fill-opacity':'0.001'
    });
    g.appendChild(hit);

 
    var berthNameFromData = berthNoToName(berths, it.ship.BerthNo);
    var ppm2 = uMap.pxPerUnit;
    // var meta = {
    //   shipName: it.ship.ShipName,
    //   shipKey:  it.ship.ShipKey,
    //   berthName: berthNameFromData,
    //   uRange: it.abs.u1.toFixed(1)+' → '+it.abs.u2.toFixed(1),
    //   uSpan:  it.abs.u1.toFixed(1)+' → '+it.abs.u2.toFixed(1)+' (pxPerUnit='+ppm2.toFixed(3)+')',
    //   size:   '~'+(w/ppm2).toFixed(1)+' m × '+(h/(ppm2*BEAM_VISUAL_SCALE)).toFixed(1)+' m (ước tính)',
    //   progress: prog,
    //   eta: it.ship.ETA || '—',
    //   etd: it.ship.ETD || it.ship.Etd || '—',
    //   equipment: it.ship.Equipment || '',
    //   oprId: it.ship.OprId || it.ship.oprId || '—',
    //   pxPerUnit: ppm2.toFixed(3)
    // };
 // --- thời gian từ API (nếu chưa có thì '—')
var berthDate = it.ship.BerthDate || null;
var atw       = it.ship.ATW       || null;
var etc       = it.ship.ETC       || null;

 
var equipStr  = (it.ship.Equipment || '').trim();
var equipList = equipStr ? equipStr.split(';').filter(function(x){ return x && x!=='*'; }) : [];
var gangCount =    null;

 
var teus         = (it.ship.TEUS != null ? it.ship.TEUS : (it.ship.TotalTEUS != null ? it.ship.TotalTEUS : null));
var productivity = (it.ship.Productivity != null ? it.ship.Productivity : null);

 
function buildVoyCode(s){
  var a = (s.ShipID||'').toString().trim();
  var b = (s.ShipYear||'').toString().trim();
  var c = (s.ShipVoy||'').toString().trim();
  var out = [a,b,c].filter(Boolean).join('-');
  return out || (s.ImVoy || s.ExVoy || '—');
}
var voyCode = buildVoyCode(it.ship);

 
var meta = {
  shipName: it.ship.ShipName,
  berthName: berthNameFromData,
  progress: prog,
  uRange: it.abs.u1.toFixed(1)+' → '+it.abs.u2.toFixed(1),
  uSpan:  it.abs.u1.toFixed(1)+' → '+it.abs.u2.toFixed(1)+' (pxPerUnit='+ppm2.toFixed(3)+')',
  size:   '~'+(w/ppm2).toFixed(1)+' m × '+(h/(ppm2*BEAM_VISUAL_SCALE)).toFixed(1)+' m (ước tính)',
  pxPerUnit: ppm2.toFixed(3),
  oprId: it.ship.OprId || it.ship.oprId || '—',
  equipment: it.ship.Equipment || '',

  gangCount: (gangCount==null ? '—' : gangCount),
  teus: (teus==null ? '—' : teus),
  productivity: (productivity==null ? '—' : productivity),

  berthDate: berthDate || '—',
  atw:       atw       || '—',
  etc:       etc       || '—',

  voyCode: voyCode
};

    // (function(meta,g,hit){
    //   function showPopoverShip(){
    //     var equipStr=(meta.equipment||'').trim();
    //     var eqList=equipStr?equipStr.split(';').filter(function(x){return x && x!=='*';}):[];
    //     var gangs=eqList.length || '—';

    //     popTitle.textContent = meta.shipName || 'Tàu';
    //     popBody.innerHTML =
    //       '<div class="sec table blue">'+
    //         '<div class="sec-hd">'+(meta.shipName||'—')+'</div>'+
    //         '<div class="sec-body"><table>'+
    //           '<tr><td>Hãng tàu</td><td>'+(meta.oprId||'—')+'</td></tr>'+
    //           '<tr><td>Bến (theo dữ liệu)</td><td>'+(meta.berthName||'—')+'</td></tr>'+
    //           '<tr><td>Số cẩu</td><td><span class="pill blue">'+(gangs)+'</span></td></tr>'+
    //           '<tr><td>Tiến độ</td><td><span class="pill green">'+((meta.progress!=null)?meta.progress:'—')+'%</span></td></tr>'+
    //         '</table></div>'+
    //       '</div>'+
    //       '<div class="sec table amber">'+
    //         '<div class="sec-hd">Thời gian</div>'+
    //         '<div class="sec-body"><table>'+
    //           '<tr><td>ETA</td><td>'+fmtDate(meta.eta)+'</td></tr>'+
    //           '<tr><td>ETD</td><td>'+fmtDate(meta.etd)+'</td></tr>'+
    //         '</table></div>'+
    //       '</div>'+
    //       '<div class="sec table gray">'+
    //         '<div class="sec-hd">Khung tàu</div>'+
    //         '<div class="sec-body"><table>'+
    //           '<tr><td>Mã chuyến</td><td>'+(meta.shipKey||'—')+'</td></tr>'+
    //           '<tr><td>Vị trí (u)</td><td>'+(meta.uRange||'—')+'</td></tr>'+
    //           '<tr><td>px/Unit</td><td>'+(meta.pxPerUnit||'—')+'</td></tr>'+
    //           '<tr class="sum-row"><td>Kích thước ước tính</td><td>'+(meta.size||'—')+'</td></tr>'+
    //         '</table></div>'+
    //       '</div>';
    //     showPopoverForSvgAnchor(g,'above');
    //   }
    //   hit.addEventListener('pointerup', function(e){ e.stopPropagation(); showPopoverShip(); }, {passive:true});
    //   if (CAN_HOVER){
    //     var hideT=null;
    //     g.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); showPopoverShip(); });
    //     g.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
    //     pop.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); });
    //     pop.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
    //   }
    // })(meta,g,hit);
 (function(meta, g, hit){
  // Tổng hợp job theo ShipKey (Container/Đã thực hiện/Còn lại)
  function summarizeJobs(jobData, shipKey){
    var rows = { nhap:{total:0, done:0}, xuat:{total:0, done:0}, dao:{total:0, done:0} };
    for (var i=0;i<(jobData||[]).length;i++){
      var j = jobData[i]; if (j.ShipKey !== it.ship.ShipKey) continue;
      var cnt = (+j.JobCount)||0;
      var done = (j.Status==='F' || j.Status==='R') ? cnt : 0;

      var mode = (j.JobMode||'').toUpperCase();
      var name = (j.JobModeName||'').toLowerCase();

      if (mode==='NTAU' || name.indexOf('nhập')>=0){ rows.nhap.total+=cnt; rows.nhap.done+=done; }
      else if (mode==='XTAU' || name.indexOf('xuất')>=0){ rows.xuat.total+=cnt; rows.xuat.done+=done; }
      else if (name.indexOf('đảo')>=0 || name.indexOf('dao')>=0){ rows.dao.total+=cnt; rows.dao.done+=done; }
    }
    rows.nhap.left = Math.max(0, rows.nhap.total - rows.nhap.done);
    rows.xuat.left = Math.max(0, rows.xuat.total - rows.xuat.done);
    rows.dao.left  = Math.max(0, rows.dao.total  - rows.dao.done);
    var total = rows.nhap.total + rows.xuat.total + rows.dao.total;
    var done  = rows.nhap.done  + rows.xuat.done  + rows.dao.done;
    return {rows:rows, total:total, done:done, left:Math.max(0,total-done)};
  }

 function esc(s){ return (s==null?'—':String(s))
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function showPopoverShip(){
  // Tổng hợp job cho 3 dòng Nhập/Xuất/Đảo + Tổng
  function summarizeJobs(jobData, shipKey){
    var rows = { nhap:{total:0,done:0}, xuat:{total:0,done:0}, dao:{total:0,done:0} };
    for (var i=0;i<(jobData||[]).length;i++){
      var j = jobData[i]; if (j.ShipKey !== it.ship.ShipKey) continue;
      var cnt=(+j.JobCount)||0, done=(j.Status==='F'||j.Status==='R')?cnt:0;
      var mode=(j.JobMode||'').toUpperCase(), name=(j.JobModeName||'').toLowerCase();
      if (mode==='NTAU'||name.indexOf('nhập')>=0){ rows.nhap.total+=cnt; rows.nhap.done+=done; }
      else if (mode==='XTAU'||name.indexOf('xuất')>=0){ rows.xuat.total+=cnt; rows.xuat.done+=done; }
      else if (name.indexOf('đảo')>=0||name.indexOf('dao')>=0){ rows.dao.total+=cnt; rows.dao.done+=done; }
    }
    rows.nhap.left=Math.max(0,rows.nhap.total-rows.nhap.done);
    rows.xuat.left=Math.max(0,rows.xuat.total-rows.xuat.done);
    rows.dao.left =Math.max(0,rows.dao.total -rows.dao.done );
    var total=rows.nhap.total+rows.xuat.total+rows.dao.total;
    var done =rows.nhap.done +rows.xuat.done +rows.dao.done ;
    return {rows:rows,total:total,done:done,left:Math.max(0,total-done)};
  }

  var agg = summarizeJobs(window.__JOB_DATA__ || jobData, it.ship.ShipKey);

 
  popTitle.textContent = meta.shipName || 'Tàu';
 
  popBody.innerHTML =
    "<div style='max-width:384px'>" +

  
      "<table style='width:100%;border-collapse:collapse'>" +
      
        "<tbody>" +
          "<tr>" +
            "<td style='border:1px solid #e5e9ef;padding:6px 8px'>Hãng tàu: <strong style='color:#0b66c3'>"+esc(meta.oprId)+"</strong></td>" +
            "<td style='border:1px solid #e5e9ef;padding:6px 8px'>Số máng: <strong style='color:#0b66c3'>"+esc(meta.gangCount)+"</strong></td>" +
          "</tr>" +
          "<tr>" +
            "<td style='border:1px solid #e5e9ef;padding:6px 8px'>Tổng TEUS: <strong style='color:#0b66c3'>"+esc(meta.teus)+"</strong></td>" +
            "<td style='border:1px solid #e5e9ef;padding:6px 8px'>Năng suất: <strong style='color:#0b66c3'>"+esc(meta.productivity)+"</strong></td>" +
          "</tr>" +
        "</tbody>" +
      "</table>" +

       
      "<div style='height:4px;background:#00468A;margin:0px 0 8px 0'></div>" +

  
      "<table style='width:100%;border-collapse:collapse'>" +
        "<tr>" +
          "<th style='text-align:left;font:600 12px system-ui;color:#223;padding:6px 8px;border:1px solid #f1f3f6;background:#fff'>Thời gian cập cầu</th>" +
          "<th style='text-align:right;font:800 12px system-ui;color:#f39c12;padding:6px 8px;border:1px solid #f1f3f6;background:#fff'>"+esc(fmtDate(meta.berthDate))+"</th>" +
        "</tr>" +
        "<tr><td style='padding:6px 8px;border:1px solid #f1f3f6'>Bắt đầu làm hàng</td><td style='padding:6px 8px;border:1px solid #f1f3f6;text-align:right'>"+esc(fmtDate(meta.atw))+"</td></tr>" +
        "<tr><td style='padding:6px 8px;border:1px solid #f1f3f6'>Dự kiến xong</td><td style='padding:6px 8px;border:1px solid #f1f3f6;text-align:right'>"+esc(fmtDate(meta.etc))+"</td></tr>" +
      "</table>" +

      
      "<div style='height:4px;background:#00468A;margin:8px 0'></div>" +

 
      "<table style='width:100%;border-collapse:collapse'>" +
        "<tr>" +
          "<th style='font-weight:400;border:1px solid #e5e9ef;padding:6px 8px;text-align:left'>"+esc(meta.voyCode)+"</th>" +
          "<th style='border:1px solid #e5e9ef;padding:6px 8px'>Container</th>" +
          "<th style='border:1px solid #e5e9ef;padding:6px 8px'>Đã thực hiện</th>" +
          "<th style='border:1px solid #e5e9ef;padding:6px 8px'>Còn lại</th>" +
        "</tr>" +
        "<tr><td style='border:1px solid #e5e9ef;padding:6px 8px'>Nhập</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.nhap.total+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.nhap.done+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.nhap.left+"</td></tr>" +
        "<tr><td style='border:1px solid #e5e9ef;padding:6px 8px'>Xuất</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.xuat.total+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.xuat.done+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.xuat.left+"</td></tr>" +
        "<tr><td style='border:1px solid #e5e9ef;padding:6px 8px'>Đảo chuyển</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.dao.total+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.dao.done+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.rows.dao.left+"</td></tr>" +
        "<tr style='background:#FFF9E2'><td style='border:1px solid #e5e9ef;padding:6px 8px'>Tổng</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.total+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.done+"</td><td style='border:1px solid #e5e9ef;text-align:center'>"+agg.left+"</td></tr>" +
      "</table>" +

    "</div>";

  showPopoverForSvgAnchor(g,'above');  
}

  window.__JOB_DATA__ = jobData;
  hit.addEventListener('pointerup', function(e){ e.stopPropagation(); showPopoverShip(); }, {passive:true});
  if (CAN_HOVER){
    var hideT=null;
    g.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); showPopoverShip(); });
    g.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
    pop.addEventListener('mouseenter', function(){ if(hideT) clearTimeout(hideT); });
    pop.addEventListener('mouseleave', function(){ hideT=setTimeout(hidePopover,160); });
  }
})(meta, g, hit);


  }
}
   
var jobsCard=document.getElementById('jobsCard'), toggleBtn=document.getElementById('toggleJobs'), jobsBody=document.getElementById('jobsBody'), jobsToggle=document.getElementById('jobsToggle');
toggleBtn.onclick=function(){ var open=!jobsCard.classList.contains('open'); jobsCard.classList.toggle('open',open); toggleBtn.classList.toggle('rotate',open); if(open){jobsBody.style.display='block'; jobsToggle.textContent='Ẩn ▲';} };
jobsToggle.onclick=function(){ var open=jobsBody.style.display!=='none'; jobsBody.style.display=open?'none':'block'; jobsToggle.textContent=open?'Hiện ▼':'Ẩn ▲'; };

function buildJobsUI(ships, berths, jobData){
  var tbody=document.querySelector('#jobsTable tbody'); tbody.innerHTML='';
  var cards=document.getElementById('jobsCards'); cards.innerHTML='';
  var seen={}, rows=[], i;

  for(i=0;i<(ships||[]).length;i++){ var s=ships[i]; if(seen[s.ShipKey]) continue; seen[s.ShipKey]=1;
    var berthName=berthNoToName(berths, s.BerthNo)||'—';
    var prog=progressFromJobs(jobData,s.ShipKey);
    rows.push({key:s.ShipKey, ship:s.ShipName||'—', berth:berthName, eta:s.ETA||'—', etd:s.ETD||s.Etd||'—', prog:prog});
  }
  rows.sort(function(a,b){ return (a.berth||'').localeCompare(b.berth||'') || (b.prog-a.prog); });

  for(i=0;i<rows.length;i++){
    var r=rows[i];
    var tr=document.createElement('tr');
    tr.innerHTML='<td>'+r.berth+'</td><td class="ship">'+r.ship+'</td>'+
      '<td class="hide-sm">'+r.key+'</td><td class="hide-sm">'+r.eta+' → '+r.etd+'</td>'+
      '<td style="min-width:160px"><div class="bar"><i style="width:'+r.prog+'%">'+r.prog+'%</i></div></td>';
    tr.addEventListener('click',(function(key){ return function(){ focusShipByKey(key); }; })(r.key));
    tbody.appendChild(tr);
  }

  for(i=0;i<rows.length;i++){
    var rr=rows[i];
    var div=document.createElement('div'); div.className='card';
    div.innerHTML='<div class="hdr">'+rr.ship+'</div>'+
      '<div class="cols">'+
      '<div>Bến</div><div>'+rr.berth+'</div>'+
      '<div>ShipKey</div><div>'+rr.key+'</div>'+
      '<div>ETA</div><div>'+rr.eta+'</div>'+
      '<div>ETD</div><div>'+rr.etd+'</div>'+
      '<div>Tiến độ</div><div><div class="bar"><i style="width:'+rr.prog+'%">'+rr.prog+'%</i></div></div>'+
      '</div>';
    div.addEventListener('click',(function(key){ return function(){ focusShipByKey(key); jobsCard.classList.remove('open'); toggleBtn.classList.remove('rotate'); }; })(rr.key));
    cards.appendChild(div);
  }
}

function focusShipByKey(shipKey){
  var g=document.querySelector('#layer-ships g.ship[data-shipkey="'+shipKey+'"]');
  if(!g) return;
  var tr=g.getCTM(), worldX=tr.e, vw=stage.clientWidth;
  var targetTx=(vw/2)-worldX*scale; var startTx=tx; var dur=250; var t0=performance.now();
  function anim(t){ var k=Math.min(1,(t-t0)/dur); tx=startTx+(targetTx-startTx)*k; apply(); if(k<1) requestAnimationFrame(anim); }
  requestAnimationFrame(anim);
}

 (async function boot(){
  try{
    var raw = await loadData();
 
    var berths = (raw.BerthData||[]).slice().sort(function(a,b){ return (+b.PosFrom||0) - (+a.PosFrom||0); }).reverse();
    var ships  = raw.ShipData || [];
    var jobs   = raw.JobData || [];

    var totalUnits = normalizeUnits(berths);
    var uMap = buildUnitToPx(totalUnits);

    drawBerths(berths, uMap);
    drawShips(ships, berths, uMap, jobs);
    buildJobsUI(ships, berths, jobs);

    requestAnimationFrame(function(){ zoomHeightNow(1.2,'map'); });
  }catch(e){
    console.error('Boot failed:', e);
  }
})();

 
window.addEventListener('DOMContentLoaded', function(){
  if (!userInteracted) requestAnimationFrame(function(){ zoomHeightNow(1.2,'map'); });
});
window.addEventListener('orientationchange', function(){
  setTimeout(function(){ zoomHeightNow(1.2,'map'); }, 150);
});
</script>
</body>
</html>
